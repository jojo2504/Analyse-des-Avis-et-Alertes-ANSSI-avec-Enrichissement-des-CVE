import { useState, useEffect } from 'react';
import axios from 'axios';
import toast, { Toaster } from 'react-hot-toast';
import './App.css';

const API_BASE = 'http://127.0.0.1:8000/api';

interface CVE {
  id: number;
  identifiant_cve: string;
  titre_bulletin: string;
  date_publication: string;
  lien_bulletin: string;
  base_severity: string;
  description: string;
}

interface EmailGroup {
  id: number;
  name: string;
  emails: string;
}

function App() {
  const [cves, setCves] = useState<CVE[]>([]);
  const [groups, setGroups] = useState<EmailGroup[]>([]);
  const [selectedCveIds, setSelectedCveIds] = useState<number[]>([]);
  const [manualEmails, setManualEmails] = useState('');
  const [selectedGroups, setSelectedGroups] = useState<number[]>([]);

  const [loading, setLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);

  // Fetch CVEs
  useEffect(() => {
    setError(null);
    axios
      .get(`${API_BASE}/cves/`)
      .then((res) => {
        console.log('CVEs loaded:', res.data);
        setCves(res.data);
      })
      .catch((err) => {
        console.error('Error loading CVEs:', err);
        setError('Failed to load CVEs. Make sure the backend is running.');
        toast.error('Failed to load CVEs');
      });
  }, []);

  // Fetch email groups
  useEffect(() => {
    axios
      .get(`${API_BASE}/email-groups/`)
      .then((res) => {
        console.log('Email groups loaded:', res.data);
        setGroups(res.data);
      })
      .catch((err) => {
        console.error('Error loading email groups:', err);
        toast.error('Failed to load email groups');
      });
  }, []);

  const toggleCve = (id: number) => {
    setSelectedCveIds((prev) =>
      prev.includes(id) ? prev.filter((x) => x !== id) : [...prev, id]
    );
  };

  const handleSend = async () => {
    if (selectedCveIds.length === 0) {
      toast.error('Select at least one CVE');
      return;
    }

    const emails = manualEmails
      .split(',')
      .map((e) => e.trim())
      .filter(Boolean);

    if (emails.length === 0 && selectedGroups.length === 0) {
      toast.error('Add at least one email or select a group');
      return;
    }

    setLoading(true);
    try {
      const res = await axios.post(`${API_BASE}/send-cve-email/`, {
        cve_ids: selectedCveIds,
        emails,
        group_ids: selectedGroups,
      });

      toast.success(
        `Email queued! (${res.data.recipients_count || '?'} recipients)`
      );

      // Optional: reset form
      setSelectedCveIds([]);
      setManualEmails('');
      setSelectedGroups([]);
    } catch (err: unknown) {
      console.error(err);
      const msg = axios.isAxiosError(err) 
        ? (err.response?.data?.error || 'Failed to send email')
        : 'Failed to send email';
      toast.error(msg);
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="App">
      <Toaster position="top-right" />

      <h1>CVE Sender (local)</h1>

      {error && (
        <div style={{ 
          padding: '20px', 
          margin: '20px', 
          backgroundColor: '#fee', 
          border: '1px solid #fcc',
          borderRadius: '4px',
          color: '#c00'
        }}>
          <strong>Error:</strong> {error}
          <br />
          <small>Check browser console for more details.</small>
        </div>
      )}

      <div className="container">
        {/* LEFT — CVEs */}
        <section className="cve-section">
          <h2>CVEs ({cves.length})</h2>

          {cves.length === 0 ? (
            <p>Loading CVEs...</p>
          ) : (
            <div className="cve-list">
              {cves.map((cve) => (
                <label key={cve.id} className="cve-item">
                  <input
                    type="checkbox"
                    checked={selectedCveIds.includes(cve.id)}
                    onChange={() => toggleCve(cve.id)}
                  />
                  <div>
                    <strong>{cve.identifiant_cve}</strong>
                    <span className={`severity ${(cve.base_severity || '').toLowerCase() || 'unknown'}`}>
                      {cve.base_severity || 'N/A'}
                    </span>
                    <p className="title">{cve.titre_bulletin}</p>
                    <a href={cve.lien_bulletin} target="_blank" rel="noopener noreferrer">
                      Link
                    </a>
                  </div>
                </label>
              ))}
            </div>
          )}
        </section>

        {/* RIGHT — Recipients & Send */}
        <section className="send-section">
          <h2>Send to</h2>

          <div className="field">
            <label>Manual emails (comma separated):</label>
            <textarea
              rows={3}
              value={manualEmails}
              onChange={(e) => setManualEmails(e.target.value)}
              placeholder="alice@example.com, bob@company.fr, ..."
            />
          </div>

          <div className="field">
            <label>Email groups:</label>
            <div className="group-list">
              {groups.map((group) => (
                <label key={group.id}>
                  <input
                    type="checkbox"
                    checked={selectedGroups.includes(group.id)}
                    onChange={() => {
                      setSelectedGroups((prev) =>
                        prev.includes(group.id)
                          ? prev.filter((id) => id !== group.id)
                          : [...prev, group.id]
                      );
                    }}
                  />
                  {group.name} ({group.emails.split(',').length} emails)
                </label>
              ))}
              {groups.length === 0 && <small>No groups yet</small>}
            </div>
          </div>

          <button
            className="send-btn"
            onClick={handleSend}
            disabled={loading || selectedCveIds.length === 0}
          >
            {loading ? 'Sending...' : `Send ${selectedCveIds.length} CVE(s)`}
          </button>

          <div className="stats">
            Selected CVEs: <strong>{selectedCveIds.length}</strong><br />
            Recipients: ≈ <strong>
              {manualEmails.split(',').filter(Boolean).length +
                selectedGroups.reduce(
                  (sum, gid) => {
                    const g = groups.find((gg) => gg.id === gid);
                    return sum + (g ? g.emails.split(',').length : 0);
                  },
                  0
                )}
            </strong>
          </div>
        </section>
      </div>
    </div>
  );
}

export default App;